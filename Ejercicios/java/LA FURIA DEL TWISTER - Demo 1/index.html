<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>La Furia del Twister ‚Äî Edici√≥n Gr√°fica Din√°mica (v6.0)</title>
  
  <style>
    /* VARIABLES DE COLOR (Modo Oscuro Predeterminado) */
    :root{
      --bg:#090d11; 
      --card:#1c1b18; 
      --accent:#ff9900; 
      --accent2:#7c4dff;
      --muted:#8c9cae;
      --text:#e6f1ff;
      --danger:#ff4d6d;
      --warn:#ffb703;
      --console-green:#54d0b4; 
      --border:#3d3429;
      --console-bg:#040608;
    }
    
    /* VARIABLES DE COLOR (Modo Claro) */
    .light-mode{
      --bg:#f0f4f8; 
      --card:#ffffff; 
      --accent:#007bff; 
      --accent2:#7c4dff;
      --muted:#6c757d;
      --text:#343a40;
      --danger:#dc3545;
      --warn:#ffc107;
      --console-green:#009688; 
      --border:#e0e0e0;
      --console-bg:#e9ecef;
    }

    /* ESTILOS GLOBALES Y LAYOUT FIJO */
    *{box-sizing:border-box}
    body{
      margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial;
      line-height:1.45;
      /* Adaptar background para ambos temas */
      background:var(--bg); 
      color:var(--text);
      transition: background 0.3s, color 0.3s;
    }
    .light-mode body {
        background: var(--bg);
    }

    header{
        position:sticky;top:0;
        background:rgba(9,13,17,.8);
        backdrop-filter:blur(12px);
        border-bottom:1px solid var(--border);
        z-index:100;
        /* Ajuste para modo claro */
        background: var(--card);
        border-bottom: 1px solid var(--border);
    }
    .light-mode header {
        background:rgba(255,255,255,.9); 
        border-bottom: 1px solid var(--border);
    }

    .game-layout {
      display: grid;
      grid-template-columns: 300px 1fr; 
      max-width: 1400px;
      margin: 0 auto;
    }
    .hud {
      position: sticky;
      top: 60px; 
      height: calc(100vh - 60px);
      padding: 20px;
      background: var(--card); 
      border-right: 1px solid var(--border);
      z-index: 50;
      overflow-y: auto; 
    }
    .main-content {
      padding: 0 20px 40px 20px;
    }
    @media (max-width:1000px){
        .game-layout {grid-template-columns: 1fr; } 
        .hud {position: static; height: auto; border-right: none;}
    }

    .wrap{max-width:100%;margin:0 auto;padding:16px 0;}
    .brand{display:flex;gap:12px;align-items:center}
    .brand svg{width:28px;height:28px;color:var(--accent)}
    .grid{display:grid;gap:16px}
    .grid.cols-3{grid-template-columns:repeat(3,minmax(0,1fr))}
    .grid.cols-2{grid-template-columns:repeat(2,minmax(0,1fr))}
    .card{
      background:var(--card); 
      border:1px solid var(--border); 
      border-radius:18px;
      box-shadow:0 10px 35px rgba(0,0,0,.3);
      padding:20px;
      transition: background 0.3s, border-color 0.3s, color 0.3s;
    }
    .light-mode .card {box-shadow:0 5px 15px rgba(0,0,0,.1);}
    
    .card h3{margin:.2rem 0 .6rem;font-weight:700;color:var(--accent)}
    .muted{color:var(--muted)}
    .pill{display:inline-flex;align-items:center;gap:8px;background:var(--bg);border:1px solid var(--border);color:var(--accent);padding:6px 10px;border-radius:999px;font-size:12px}
    
    /* Botones adaptativos */
    .btn{
      cursor:pointer;user-select:none;border:1px solid var(--border);
      background:var(--card); 
      color:var(--text);padding:10px 14px;border-radius:10px;font-weight:600;
      transition:.15s;box-shadow:inset 0 0 0 1px rgba(255,255,255,.04);
      display:flex;align-items:center;gap:8px;
    }
    .light-mode .btn{background:#e9ecef;box-shadow:none;}

    .btn:hover:not(:disabled){transform:translateY(-1px);box-shadow:0 6px 20px rgba(0,0,0,.2),inset 0 0 0 1px rgba(255,255,255,.08)}
    .btn.accent{border-color:var(--accent);background:var(--accent);color:#fff}
    .btn.small{padding:6px 10px;font-size:14px}
    .tag{display:inline-block;background:var(--bg);border:1px dashed var(--border);color:var(--accent);padding:6px 10px;border-radius:8px;font-size:12px}
    .light-mode .tag{background:#f8f9fa;}

    .btn:disabled{opacity: 0.5;cursor: not-allowed;transform: none !important;box-shadow: none !important;background: var(--bg) !important;border-color: var(--border) !important;}
    
    /* CONSOLA */
    .console{background:var(--console-bg);border:2px solid var(--accent);border-radius:14px;overflow:hidden;box-shadow:0 0 15px rgba(255,153,0,.2)}
    .light-mode .console{box-shadow:0 0 10px rgba(0,0,0,.1);border:2px solid var(--accent);}

    .console .top{display:flex;align-items:center;gap:8px;padding:10px 12px;background:var(--bg);border-bottom:1px solid var(--border)}
    .console-log {
        margin:0;padding:14px;height: 380px; overflow:auto;color:#c0ffeb;
        font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace;font-size:13px;
        white-space: pre-wrap; 
    }
    .light-mode .console-log {color:var(--text);}

    .console .prompt{color:var(--console-green)}
    .console .warn{color:var(--warn)}
    .console .err{color:var(--danger)}
    
    .meter{height:10px;background:var(--bg);border:1px solid var(--border);border-radius:999px;overflow:hidden;margin-block:4px}
    .meter>span{display:block;height:100%;background:linear-gradient(90deg,var(--accent),#ffc166);transition:width .3s ease-out}

    .slot{display:inline-flex;align-items:center;gap:6px;border:1px dashed var(--border);border-radius:10px;padding:6px 8px;margin:4px;background:var(--bg)}
    .light-mode .slot{background:#f8f9fa;}

    .console-input{
        background: var(--console-bg);
        border: none;
        border-top: 1px solid var(--accent);
        color: var(--console-green);
        padding: 10px 14px;
        font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;
        font-size: 13px;
        width: 100%;
        outline: none;
    }
    .light-mode .console-input{color:var(--console-green);background:#fff;}


    /* ESTILOS DE IMAGEN */
    #gameImage { /* ID del contenedor que ahora albergar√° la imagen din√°mica */
        width: 100%;
        height: 100%;
        background-size: contain; /* Ajuste crucial: se asegura que la imagen entera se vea */
        background-repeat: no-repeat;
        background-position: center;
        border-radius: 14px;
        border: 2px solid var(--accent);
        margin-bottom: 20px;
        opacity: 0.9;
        transition: opacity 0.5s ease;
    }

    /* URLS DE IM√ÅGENES (Referencias ACTUALIZADAS) */
    .map-initial { background-image: url('Gemini_Generated_Image_lfm0yqlfm0yqlfm0.png'); opacity: 0.9; } 
    .image-mountain { background-image: url('montain.png'); } 
    .image-forest { background-image: url('bosque.png'); } 
    .image-bunker { background-image: url('bunke.png'); } 
    .image-enemy-mountain { background-image: url('enemigoMont.png'); } 
    .image-enemy-forest { background-image: url('enemigoBosque.png'); } 
    .image-enemy-bunker { background-image: url('enemigoBunker.png'); } 
    .image-twister { background-image: url('finalGano.png'); } 
    .image-defeat { background-image: url('finalPerdio.png'); } 

  </style>
</head>
<body>
  <header>
    <div class="wrap" style="display:flex;align-items:center;justify-content:space-between;gap:16px; padding-left: 20px; padding-right: 20px;">
      <div class="brand">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
          <path d="M12 2L2 12h5l-3 6h14l-3-6h5z"/>
        </svg>
        <strong style="font-size:1.4rem; color:var(--accent)">LA FURIA DEL TWISTER</strong>
        <span class="pill"><span class="led green"></span> Edici√≥n Din√°mica</span>
      </div>
      <div style="display:flex;gap:8px;align-items:center">
        <button class="btn small" onclick="showHelp()">‚ùì Ayuda</button>
        <button class="btn small" id="themeToggle" onclick="toggleTheme()">üí° Tema Claro</button>
        <button class="btn small ghost" onclick="resetDemo()">Reiniciar Partida</button>
        <button class="btn small accent" onclick="startDemo()">Iniciar Simulaci√≥n</button>
      </div>
    </div>
  </header>

  <div class="game-layout">
    
    <div class="hud card">
        <h3 style="margin-top:0">‚ö° Estado del Superviviente</h3>
        <div style="display:grid;grid-template-columns:1fr;gap:10px;align-items:center;margin-top:10px">
          <div class="meter-label muted">Energ√≠a</div>
          <div class="meter" id="meterEnergy"><span style="width:100%"></span></div>
          <div class="meter-label muted">Salud</div>
          <div class="meter" id="meterHealth"><span style="width:100%"></span></div>
        </div>
        
        <h4 style="margin-top:20px; color:var(--text); font-size:1.1rem; border-top:1px dashed #1a150e; padding-top:15px;">üéí Inventario <span id="bagCount" class="pill">0 / 9</span></h4>
        <div id="bagSlots" style="min-height:40px">
            <p class="muted" style="font-size:14px;">A√±ade suministros en Fase 2.</p>
        </div>
        <div class="foot" style="margin-top:15px; border-top:1px dashed #1a150e; padding-top:10px;">
            **Refugio Actual:** <span id="refugeDisplay" style="color:var(--warn)">Pendiente</span>.<br>
            
             <h4 style="margin-top:20px; color:var(--warn)">Fase Actual: <span id="currentPhaseDisplay" style="color:var(--accent)">INICIO</span></h4>
                   
                    <h4 style="margin-top:15px; color:var(--text); border-top:1px dashed #1a150e; padding-top:10px;">Rondas de Ataque <span id="roundTag" class="pill">Ronda 0/3</span></h4>
        </div>
        
        
    </div>
    
    <main class="main-content">
        
        <div style="padding-top:20px;">
            <h1 style="font-size:clamp(34px,5vw,56px);line-height:1.05;margin:8px 0 6px;font-weight:800;text-shadow:0 0 10px rgba(255,153,0,.3)">La Furia del Twister ¬°Sobrevive a la Tormenta!</h1>
                        <div id="historyAndPhaseContainer">
                <div id="historyAndPhase" class="card" style="margin-bottom: 20px;">
                    <h3>üìú Historia y Fases del Juego</h3>
                    <p>Un Twister de categor√≠a F5, apodado "La Furia", se acerca a su ubicaci√≥n. Tienen 15 minutos para prepararse y elegir el mejor lugar para sobrevivir. Su Energ√≠a inicial es de 100% y su Salud inicial es de 100%.</p>
                    <p class="muted">Tu objetivo es llegar al refugio y superar las rondas de ataque antes de que el Twister te alcance. La gesti√≥n de tu **Inventario (5/9 espacios requeridos)** y tu **Energ√≠a** son vitales.</p>

                    <div style="border-left:3px solid var(--accent); padding-left:15px; margin-top:15px; font-style: italic;">
                        "El tiempo se acaba. La monta√±a es segura pero el ascenso te agotar√°. El bosque tiene recursos pero es peligroso. El b√∫nker es herm√©tico, pero ¬øtendr√° lo que necesito?"
                    </div>
                </div>

            </div>
        </div>

        
        <section class="grid cols-2" style="margin-bottom:20px;">

            <div id="historyAndPhaseContainer">

                <div class="console" id="console">
                    <div class="top"><div class="led"></div><div class="led"></div><div class="led green"></div><span style="margin-left:8px;color:var(--accent)">LOG DE DECISIONES</span></div>
                    <div id="log" class="console-log">$ SISTEMA LISTO. Pulsa "Iniciar Simulaci√≥n".</div>
                    <input type="text" id="consoleInput" class="console-input" placeholder="> Escribe tu comando aqu√≠..." disabled onkeydown="handleInput(event)">
                </div>
            </div>


            <div id="gameImage" class="map-initial">
                
            </div>
            
        </section>

        <section class="grid cols-3" style="margin-top:20px;">

            <div class="card">
                <h3>1) Elegir Refugio</h3>
                <p>Deber√°n elegir entre 3 refugios. La elecci√≥n inicial consumir√° energ√≠a por el traslado y generar√° un da√±o inicial a su salud. ¬°Cada uno tiene un suministro clave que deber√°n encontrar!</p>
                <p class="muted">**Comando:** <span style="color:var(--console-green)">[Refugio]</span></p>
                <div style="line-height:2.2" id="refugeButtons">
                    <button class="btn small" onclick="logRefugeTip('Monta√±a')">‚õ∞Ô∏è Monta√±a (Riesgo bajo, -25 E)</button><br>
                    <button class="btn small" onclick="logRefugeTip('Bosque')">üå≤ Bosque (Riesgo medio, -15 E)</button><br>
                    <button class="btn small" onclick="logRefugeTip('B√∫nker')">üèöÔ∏è B√∫nker (Riesgo alto, -10 E)</button>
                </div>
            </div>

            <div class="card">
                <h3>2) Gesti√≥n de Suministros (Min. 5, M√°x. 9)</h3>
                <p>Antes de que lleguen los ataques, tienen tiempo para recolectar. Tienen una Valija con un l√≠mite de 9 espacios </p>
                <p class="muted">**Comando:** <span style="color:var(--console-green)">a√±adir [nombre]</span> o <span style="color:var(--console-green)">quitar [nombre]</span></p>
                <p class="muted" style="margin-bottom:8px;">Lista de Suministros:</p>
                <div id="suppliesList" style="display:flex;flex-wrap:wrap;gap:8px">
                    </div>
                <div class="foot">
                    **Comando Avance:** <span style="color:var(--console-green)">Avanzar</span> (Cuando tienes 5 suministros).<br>
                    **Comando Combinaci√≥n:** <span style="color:var(--console-green)">Combinar Hierbas</span> (Requiere 2).
                </div>
            </div>

            <div class="card">
                <h3>Fase 4 & 5- Final</h3>
                <p>Fase 4: Vienen 3 Rondas de Ataque. Cada refugio atrae un enemigo diferente. En cada ronda, el jugador debe decidir: Ataque (sufrir√°s da√±o) o Usar Suministro Clave (mitigar da√±o de esa ronda). Al final de las 3 rondas, se desbloquea un Mini-Juego (Puzzle). Si lo resuelves (ej. adivinar un n√∫mero entre 1 y 5), ¬°ganas 1 Suministro Extra!
</p>
                <h4 style="color:var(--warn); margin-top:0;">Puzzle (Fase 4)</h4>
                <p class="muted">**Comando:** <span style="color:var(--console-green)">Adivinar [1-5]</span></p>
                
                <h4 style="color:var(--accent); margin-top:15px;">Twister Final (Fase 5)</h4>
                <p>El Twister "La Furia" finalmente los alcanza.

El Twister inflige un Da√±o de 40% a 50% de Energ√≠a y 20% a 30% de Salud.

¬°La Clave para Ganar! Para aplacar la furia y reducir el da√±o a la mitad, debes Tener y Usar el Suministro Clave aleatorio de tu refugio.

Condici√≥n de Victoria: Sobrevivir (Salud > 0, Energ√≠a > 0) Y tener el Suministro Clave que te salv√≥.</p>
                <p class="muted">**Comando:** <span style="color:var(--console-green)">Finalizar</span> (Resolver√° el enfrentamiento).</p>
               
            </div>
            
        </section>

    </main>
  </div>

  <script>
    // --- Estado de juego (simulaci√≥n) ---
    const state = {
      started:false,
      refuge:null,
      energy:100,
      health:100,
      bag:[], // hasta 9
      rounds:0,
      puzzleSecret: Math.ceil(Math.random()*5),
      currentPhase: 'START',
      isPuzzleSolved: false
    };

    const allSupplies = [
      {id:'agua', label:'üíß Agua', name:'agua', tip: 'Recupera 10 Energ√≠a.'},
      {id:'comida', label:'üçñ Comida', name:'comida', tip: 'Recupera 10 Salud.'},
      {id:'hierba', label:'üåø Hierba', name:'hierba', tip: '√ötil para combinaci√≥n.'},
      {id:'municion', label:'üî´ Munici√≥n', name:'municion', tip: 'Evita da√±o en combate.'},
      {id:'cuerda', label:'üß∂ Cuerda', name:'cuerda', tip: 'Puede ser un elemento clave.'},
      {id:'fuego', label:'üî• F√≥sforos', name:'fosforos', tip: '√ötil en Bosque (consume 5 Energ√≠a).'},
      {id:'linterna', label:'üî¶ Linterna', name:'linterna', tip: 'Puede ser un elemento clave.'},
      {id:'botiquin', label:'ü©π Botiqu√≠n', name:'botiquin', tip: 'Recupera 20 Salud.'},
      {id:'bengala', label:'üéÜ Bengala', name:'bengala', tip: 'Puede ser un elemento clave.'},
      {id:'llave', label:'üîë Llave', name:'llave', tip: 'Puede ser un elemento clave.'},
      {id:'medicina', label:'üß™ Medicina', name:'medicina', tip: 'Recupera 20 Salud y 20 Energ√≠a.'} // Combinaci√≥n
    ];
    
    // Lista de suministros que pueden ser CLAVE (A√∫n se usa para el c√°lculo final)
    const possibleKeys = allSupplies.filter(s => ['cuerda', 'municion', 'bengala', 'linterna', 'llave', 'fuego', 'hierba', 'botiquin', 'agua', 'comida'].includes(s.id)).map(s => s.id);

    // Mapeo de nombres simplificado para el input (incluye 'fosforos' y 'f√≥sforos')
    const suppliesMap = allSupplies.reduce((acc, s) => {
        acc[s.name.toLowerCase()] = s.id;
        if (s.name.toLowerCase() === 'fosforos') {
            acc['f√≥sforos'] = s.id; // A√±adir versi√≥n con tilde
        }
        return acc;
    }, {});
    
    // Funci√≥n para obtener 1 suministros clave aleatorios sin repetici√≥n
function getRandomKeys() {
    const keys = [...possibleKeys];
    const result = [];
    const randomIndex = Math.floor(Math.random() * keys.length);
    result.push(keys[randomIndex]);
    return result; // solo 1 clave posible
}

    const enemyData = {
        'monta√±a': {
            name: 'El Yeti Pillo', 
            weakness: 'bengala', 
            attack: 'Avalancha de bolas de nieve', 
            desc: 'Una criatura peluda y juguetona con una fuerza brutal. Su debilidad es el fuego o las luces brillantes.',
            keyId: 'bengala', 
            image: 'image-enemy-mountain'
        },
        'bosque': {
            name: 'La Niebla Silbadora', 
            weakness: 'fosforos', 
            attack: 'Cortes de visi√≥n y desorientaci√≥n', 
            desc: 'Una entidad et√©rea que reduce tu visibilidad y te confunde. Su debilidad es el calor concentrado.',
            keyId: 'fosforos', 
            image: 'image-enemy-forest'
        },
        'b√∫nker': {
            name: 'El Saboteador Glitch', 
            weakness: 'linterna', 
            attack: 'Pulso electromagn√©tico (EMP)', 
            desc: 'Un humanoide r√°pido que manipula la electr√≥nica y la oscuridad. Su debilidad son las luces de alta intensidad.',
            keyId: 'linterna', 
            image: 'image-enemy-bunker'
        }
    };

    const refugeData = {
      'monta√±a':{cost:25, enemy:'El Yeti Pillo', image:'image-mountain', enemyImage: 'image-enemy-mountain'},
      'bosque':{cost:15, enemy:'La Niebla Silbadora', image:'image-forest', enemyImage: 'image-enemy-forest'},
      'b√∫nker':{cost:10, enemy:'El Saboteador Glitch', image:'image-bunker', enemyImage: 'image-enemy-bunker'}
    };
    
    // Referencias DOM
    const logEl = document.getElementById('log');
    const consoleInput = document.getElementById('consoleInput');
    const phaseDisplay = document.getElementById('currentPhaseDisplay');
    const gameImageEl = document.getElementById('gameImage'); // Ahora la imagen din√°mica
    const refugeButtons = document.getElementById('refugeButtons').querySelectorAll('button');
    
    // Tema Claro/Oscuro
    function toggleTheme() {
        const body = document.body;
        const button = document.getElementById('themeToggle');
        body.classList.toggle('light-mode');
        
        if (body.classList.contains('light-mode')) {
            button.textContent = 'üí° Tema Oscuro';
        } else {
            button.textContent = 'üí° Tema Claro';
        }
    }

    function log(txt){
      logEl.innerHTML += txt + "<br>";
      logEl.scrollTop = logEl.scrollHeight;
    }
    function updatePhaseDisplay(phaseName){
        phaseDisplay.textContent = phaseName;
    }

    // Funci√≥n modificada para apuntar al nuevo ID de la imagen y limpiar clases.
    function updateImage(className){
        // Limpia todas las clases de imagen y a√±ade la nueva
        gameImageEl.className = 'card'; 
        gameImageEl.classList.add(className);
    }

    function updateRefugeButtons(enable = false){
        refugeButtons.forEach(btn => {
            btn.disabled = !enable;
        });
    }

    function updateMeters(){
      const e = Math.max(0,Math.min(100,state.energy));
      const h = Math.max(0,Math.min(100,state.health));
      
      document.querySelector('#meterEnergy span').style.width = e + '%';
      document.querySelector('#meterHealth span').style.width = h + '%';
      
      document.getElementById('meterEnergy').className = 'meter' + (e<30? ' danger' : e<60? ' warn':'' );
      document.getElementById('meterHealth').className = 'meter' + (h<30? ' danger' : h<60? ' warn':'' );
      
      document.getElementById('refugeDisplay').textContent = state.refuge || 'Pendiente';
    }

    function renderBag(){
      document.getElementById('bagCount').textContent = state.bag.length + ' / 9';
      const wrap = document.getElementById('bagSlots');
      wrap.innerHTML='';
      state.bag.forEach(id=>{
        const sup = allSupplies.find(s=>s.id===id);
        const el = document.createElement('span');
        el.className = 'slot';
        el.textContent = sup.label;
        wrap.appendChild(el);
      })
      buildSuppliesUI(); 
      checkSupplyPhaseCompletion(); 
    }

    function buildSuppliesUI(){
      const box = document.getElementById('suppliesList');
      box.innerHTML = '';
      allSupplies.filter(s => s.id !== 'medicina' || state.bag.includes('medicina')).forEach(s=>{
        const isSelected = state.bag.includes(s.id);
        
        const el = document.createElement('span');
        el.className = 'tag';
        el.title = s.tip; 
        el.style.backgroundColor = isSelected ? 'rgba(255,153,0,0.2)' : '';
        el.style.borderColor = isSelected ? 'var(--accent)' : 'var(--muted)';
        el.style.color = isSelected ? 'white' : 'var(--muted)';
        el.textContent = s.label + (isSelected ? ' [OK]' : '');
        box.appendChild(el);
      })
    }
    
    function logRefugeTip(name){
        if(state.currentPhase !== 'REFUGE') return; 
        const refName = name.toLowerCase();
        const refData = refugeData[refName];
        log(`> INFO: Elegir ${name} cuesta ${refData.cost} Energ√≠a. Enemigo: ${refData.enemy}.`);
    }

    function startDemo(){
      if(state.started){ log('> La simulaci√≥n ya est√° en curso. Reinicia si quieres empezar de nuevo.'); return; }
      
      // 1. Resetear estado completo y generar nuevas claves (sin mostrarlas)
      state.keySupplies = getRandomKeys();
      Object.assign(state,{started:true,refuge:null,energy:100,health:100,bag:[],rounds:0,puzzleSecret:Math.ceil(Math.random()*5), currentPhase: 'REFUGE', isPuzzleSolved: false});
      
      // 2. Log de inicio
      log('$ SISTEMA INICIADO. ¬°El Twister se acerca!');
      log('> FASE 1: ELIGE REFUGIO. Escribe el nombre (ej: <span class="warn">Bosque</span>).');
      
      // 3. Renderizado y UI
      document.getElementById('roundTag').textContent = 'Ronda 0/3';
      updateMeters(); renderBag(); 
      updateImage('map-initial');
      updateRefugeButtons(true); 
      consoleInput.disabled = false;
      consoleInput.placeholder = "> Escribe el nombre del Refugio...";
      consoleInput.focus();
      updatePhaseDisplay('1. REFUGIO');
    }

    function chooseRefuge(name){
      if(!state.started || state.refuge || state.currentPhase !== 'REFUGE'){ log('! No es momento de elegir refugio.'); return; }
      
      const refName = name.toLowerCase();
      const refData = refugeData[refName];
      if(!refData){
          log(`! Opci√≥n no v√°lida. Elige: Monta√±a, Bosque o B√∫nker.`);
          return;
      }
      
      state.refuge = refName; 
      state.energy = Math.max(0, state.energy - refData.cost);
      
      log(`<span class="prompt">‚úî REFUGIO SELECCIONADO:</span> <span class="accent">${refName.toUpperCase()}</span>. Coste: -${refData.cost} Energ√≠a.`);
      log(`> Enemigo caracter√≠stico: ${refData.enemy}.`);
      
      updateRefugeButtons(false);
      
      state.currentPhase = 'SUPPLIES';
      log(`\n> FASE 2: GESTI√ìN DE SUMINISTROS (VALIJA: ${state.bag.length}/9. M√≠nimo 5).`);
      log(`> Escribe: <span class="console-green">a√±adir [nombre]</span> o <span class="console-green">quitar [nombre]</span>.`);
      log('! TIP: Elige con sabidur√≠a. Cuando tengas 5 suministros, escribe <span class="warn">AVANZAR</span>.');
      consoleInput.placeholder = "> Escribe un comando (ej: a√±adir agua)...";
      updateMeters();
      updateImage(refData.image);
      updatePhaseDisplay('2. SUMINISTROS');
    }
    
    function useSupply(supplyName){
        const supplyId = suppliesMap[supplyName.toLowerCase()];
        if(!supplyId){ log(`! Suministro '${supplyName}' no reconocido.`); return false; }

        const i = state.bag.indexOf(supplyId);
        if(i === -1){ log(`! El suministro '${supplyName}' no est√° en la valija.`); return false; }

        let used = false;
        
        switch(supplyId){
            case 'agua':
                state.energy = Math.min(100, state.energy + 10); used = true;
                log(`+ Usaste üíß Agua. Ganaste 10 Energ√≠a.`);
                break;
            case 'comida':
                state.health = Math.min(100, state.health + 10); used = true;
                log(`+ Usaste üçñ Comida. Ganaste 10 Salud.`);
                break;
            case 'botiquin':
                state.health = Math.min(100, state.health + 20); used = true;
                log(`+ Usaste ü©π Botiqu√≠n. Ganaste 20 Salud.`);
                break;
            case 'medicina':
                state.health = Math.min(100, state.health + 20);
                state.energy = Math.min(100, state.energy + 20); used = true;
                log(`+ Usaste üß™ Medicina. Ganaste 20 Salud y 20 Energ√≠a.`);
                break;
            case 'fosforos': 
                if (state.refuge === 'bosque') {
                    state.energy = Math.max(0, state.energy - 5);
                    used = true;
                    log(`+ Usaste üî• F√≥sforos. Gastaste 5 Energ√≠a en encender una hoguera temporal (efecto narrativo/moral).`);
                } else {
                    log(`! Los F√≥sforos no tienen un uso inmediato fuera de combate en este refugio.`);
                    return false;
                }
                break;
            default:
                log(`! El suministro '${supplyName.toUpperCase()}' no se puede usar para este prop√≥sito ahora.`);
                return false;
        }

        if(used){
            if (['agua', 'comida', 'botiquin', 'medicina', 'fosforos'].includes(supplyId)) {
                state.bag.splice(i, 1);
            }
            updateMeters();
            renderBag();
            return true;
        }
        return false;
    }

    function checkSupplyPhaseCompletion(){
        if(state.currentPhase === 'SUPPLIES'){
            if(state.bag.length >= 5){
                log(`\n<span class="warn">¬°VALIJA LISTA (${state.bag.length}/9)!</span> Tienes suficiente para resistir. Escribe <span class="console-green">AVANZAR</span> para iniciar los Ataques (Fase 3).`);
                consoleInput.placeholder = "> Escribe AVANZAR...";
            } else {
                 consoleInput.placeholder = "> Escribe a√±adir [suministro]...";
            }
        }
    }

    function handleSupplyCommand(command, arg){
        
        if((command === 'usar' || command === 'usar') && arg && state.currentPhase === 'ATTACKS'){
            const supplyId = suppliesMap[arg.toLowerCase()];
            const isCurative = ['agua', 'comida', 'botiquin', 'medicina'].includes(supplyId);
            
            if(isCurative){
                if(useSupply(arg)){
                    log('! Usaste un suministro curativo entre los preparativos. ¬°No cuenta como ronda de ataque!');
                }
                return;
            } else {
                 attackRound('usar', arg);
                 return;
            }
        }
        
        if(state.currentPhase !== 'SUPPLIES' && state.currentPhase !== 'ATTACKS'){ 
            log('! Debes estar en Fase 2 (Suministros) o Fase 3 (Ataques, para usar curativos) para gestionar la valija.'); 
            return; 
        }

        if(command === 'usar'){
            useSupply(arg);
            return;
        }
        
        const supplyId = suppliesMap[arg.toLowerCase()];

        if(command === 'combinar' && arg.toLowerCase() === 'hierbas'){
            const hierbaCount = state.bag.filter(id => id === 'hierba').length;
            if(hierbaCount >= 2 && !state.bag.includes('medicina')){
                let first = state.bag.indexOf('hierba');
                if (first !== -1) state.bag.splice(first, 1);
                let second = state.bag.indexOf('hierba');
                if (second !== -1) state.bag.splice(second, 1);
                
                if(state.bag.length < 9){
                    state.bag.push('medicina');
                    log('<span class="prompt">‚úî CREACI√ìN:</span> Combinaste 2 Hierbas y obtuviste üß™ Medicina.');
                } else {
                    log('! Valija llena. No hay espacio para la Medicina combinada.');
                }
            } else if(state.bag.includes('medicina')) {
                log('! Ya tienes üß™ Medicina en tu valija.');
            } else {
                log('! Necesitas al menos 2 Hierbas para la combinaci√≥n.');
            }
            renderBag();
            return;
        }

        if(state.currentPhase === 'ATTACKS') {
             log('! En Fase de Ataques solo puedes <span class="console-green">Usar [suministro curativo]</span>, <span class="console-green">Atacar</span> o <span class="console-green">Defender</span>.');
             return;
        }

        if(!supplyId){
            log(`! Suministro '${arg}' no reconocido o comando inv√°lido. Intenta: a√±adir [nombre].`);
            return;
        }

        if(command === 'a√±adir'){
            if(state.bag.length>=9){ log('! VALIJA LLENA (9/9). No puedes a√±adir m√°s.'); return; }
            state.bag.push(supplyId); log(`+ Agregaste ${supplyId}.`);
        } else if(command === 'quitar'){
            const i = state.bag.indexOf(supplyId);
            if(i>=0){
                state.bag.splice(i,1); log(`- Quitaste ${supplyId}.`);
            } else {
                log(`! El suministro '${supplyId}' no est√° en la valija.`);
            }
        } else {
            log('! Comando de suministro inv√°lido. Usa "a√±adir [nombre]" o "quitar [nombre]".');
        }
        renderBag();
    }
    
   // --- FUNCI√ìN DE RONDAS DE ATAQUE MEJORADA ---
function attackRound(action, supply = null) {
  if (state.currentPhase !== "ATTACKS") {
    log("! Debes estar en la Fase de Ataques para esta acci√≥n.");
    return;
  }

  if (state.rounds >= 3) {
    log("> Ya completaste las 3 rondas. Procede al Puzzle (Fase 4).");
    state.currentPhase = "PUZZLE";
    consoleInput.placeholder = "> Escribe 'Adivinar [1-5]' o 'Finalizar'...";
    updatePhaseDisplay("4. PUZZLE");
    updateImage(refugeData[state.refuge].image);
    return;
  }

  state.rounds++;
  const refName = state.refuge.toLowerCase();
  const refData = enemyData[refName];
  updateImage(refData.image);

  const weaknessID = refData.keyId;
  const weaknessSupply = allSupplies.find((s) => s.id === weaknessID);
  const weaknessLabel = weaknessSupply ? weaknessSupply.label : "??";

  // Recordatorio antes de actuar
  log(
    `\n> ATAQUE ${state.rounds}/3 ‚Äî <span class="err">${refData.name.toUpperCase()}</span>`
  );
  log(
    `üí° PISTA: ${refData.name} teme a <span class="warn">${weaknessLabel}</span>. (${refData.desc})`
  );

  let baseDamage = 15 + Math.floor(Math.random() * 10);
  let energyCost = 5;
  let mitigated = false;

  // --- ATACAR ---
  if (action === "atacar") {
    energyCost += 10;

    if (state.bag.includes("municion") || state.bag.includes("munici√≥n")) {
      // Corrige el uso con y sin tilde
      const index =
        state.bag.indexOf("municion") !== -1
          ? state.bag.indexOf("municion")
          : state.bag.indexOf("munici√≥n");
      state.bag.splice(index, 1);
      baseDamage = 0;
      mitigated = true;
      log(
        `‚úî <span class="console-green">ATACAR:</span> Usaste üî´ Munici√≥n. Neutralizaste a ${refData.name}.`
      );
    } else {
      baseDamage = Math.floor(baseDamage * 0.8);
      log(
        `‚ùå <span class="err">ATACAR:</span> No ten√≠as Munici√≥n. Recibes el ataque parcial (${refData.attack}).`
      );
    }
  }

  // --- DEFENDER ---
  else if (action === "defender") {
    energyCost += 5;
    if (state.bag.includes(weaknessID)) {
      const i = state.bag.indexOf(weaknessID);
      state.bag.splice(i, 1);
      baseDamage = 0;
      mitigated = true;
      log(
        `üõ°Ô∏è <span class="console-green">DEFENDER:</span> Usaste ${weaknessLabel}. ${refData.name} retrocede aturdido.`
      );
    } else {
      log(
        `‚ùå <span class="err">DEFENDER:</span> No tienes el suministro clave (${weaknessLabel}). ${refData.attack} te alcanza.`
      );
    }
  }

  // --- USAR SUMINISTRO (curativo) ---
  else if (action === "usar" && supply) {
    const id = suppliesMap[supply.toLowerCase()];
    if (!id) {
      log(`! El suministro '${supply}' no es v√°lido.`);
      return;
    }
    const curative = ["agua", "comida", "botiquin", "medicina"];
    if (curative.includes(id)) {
      useSupply(supply);
      log(
        `üíä Recuperaste fuerzas antes del siguiente ataque. ¬°Prep√°rate!`
      );
      return;
    } else {
      log(
        `‚ùå ${supply.toUpperCase()} no tiene efecto en combate. Recibes el impacto del enemigo.`
      );
    }
  }

  // --- APLICAR RESULTADOS ---
  state.energy = Math.max(0, state.energy - energyCost);
  state.health = Math.max(0, state.health - baseDamage);

  const damageInfo =
    baseDamage === 0
      ? "Sin da√±o recibido."
      : `Da√±o recibido: -${baseDamage} Salud.`;

  log(
    `‚ö° Coste de Energ√≠a: -${energyCost}. ${damageInfo} (Salud: ${state.health} | Energ√≠a: ${state.energy})`
  );

  document.getElementById(
    "roundTag"
  ).textContent = `Ronda ${state.rounds}/3`;
  updateMeters();
  renderBag();

  // --- TRANSICI√ìN DE FASE ---
  if (state.rounds < 3) {
    log(
      `\nüëâ Escribe tu siguiente acci√≥n: <span class="console-green">Atacar</span>, <span class="console-green">Defender</span>, o <span class="console-green">Usar [suministro curativo]</span>.`
    );
  } else {
    log(
      `\nüéØ <span class="prompt">FIN DE ATAQUES.</span> Pasas a la FASE 4: PUZZLE.`
    );
    log(
      `üí≠ Escribe <span class="console-green">Adivinar [1-5]</span> para intentar resolver el acertijo y ganar un suministro extra.`
    );
    state.currentPhase = "PUZZLE";
    updatePhaseDisplay("4. PUZZLE");
    updateImage(refugeData[state.refuge].image);
    consoleInput.placeholder = "> Escribe 'Adivinar [1-5]'...";
  }
}


function handlePuzzleInput(input){
    if(state.currentPhase !== 'PUZZLE' || state.isPuzzleSolved){ 
        log('! El puzzle ya fue resuelto o a√∫n no llegaste a esa fase.'); 
        return; 
    }
    
    if(!input){
        log(`üß† PUZZLE ACTIVO: Intenta adivinar el n√∫mero secreto entre 1 y 5.`);
        log(`üí° Escribe: <span class="console-green">Adivinar [1-5]</span>`);
        log(`‚åõ El Twister se acerca... ¬°Tienes solo una oportunidad!`);
        return;
    }

    const v = Number(input);
    if(isNaN(v) || v < 1 || v > 5){ 
        log('! Ingresa un n√∫mero v√°lido entre 1 y 5.'); 
        return; 
    }

    log(`> Intentas con el n√∫mero ${v}...`);
    const delay = Math.floor(Math.random() * 1000) + 500;
    setTimeout(() => {
        if(v === state.puzzleSecret){
            state.isPuzzleSolved = true;
            log(`<span class="prompt">‚úî PUZZLE RESUELTO.</span> Has logrado descifrar el c√≥digo.`);
            log(`üéÅ Ganas un **Botiqu√≠n** (si hay espacio disponible).`);
            if(state.bag.length < 9){ 
                state.bag.push('botiquin'); 
                renderBag(); 
            } else {
                log('‚ö†Ô∏è Valija llena. Botiqu√≠n de bonificaci√≥n perdido.');
            }
        } else {
            log(`‚úñ PUZZLE FALLIDO. El n√∫mero correcto era ${state.puzzleSecret}.`);
            log(`‚ö° No obtienes ning√∫n suministro. El rugido del Twister se intensifica...`);
        }

        log(`\nüå™Ô∏è FASE 5: El Twister llega al refugio. Escribe <span class="console-green">Finalizar</span> para enfrentar la tormenta.`);
        state.currentPhase = 'FINAL';
        consoleInput.placeholder = "> Escribe 'Finalizar' para el Twister...";
        updatePhaseDisplay('5. FINAL');
        updateMeters();
    }, delay);
}

 // --- FUNCI√ìN FINAL DEL JUEGO MEJORADA ---
function finalBattle() {
  if (state.currentPhase !== "FINAL") {
    log("! Debes completar todas las fases anteriores antes del enfrentamiento final.");
    return;
  }
  if (!state.refuge || state.rounds < 3) {
    log("! No puedes iniciar el final sin completar las rondas de ataque.");
    return;
  }

  state.currentPhase = "FINALIZED";
  updateImage("image-twister");

  log("\nüå™Ô∏è <span class='prompt'>TWISTER FINAL: LA FURIA TE ALCANZA...</span>");
  log(
    "üí® El aire se vuelve denso y el ruido ensordecedor. Todo tiembla mientras la tormenta arrasa tu refugio..."
  );

  // Da√±o base del Twister
  let energyDamage = 40 + Math.floor(Math.random() * 10);
  let healthDamage = 20 + Math.floor(Math.random() * 10);
  let mitigated = false;
  let savedBySupply = null;
  // --- Determinar el suministro clave del refugio actual ---
  const refName = state.refuge.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, ""); 
  // üî∏ Normaliza eliminando tildes ("b√∫nker" -> "bunker")

  // Mapeo defensivo para evitar errores por tilde o may√∫sculas
  const refugeKeyMap = {
    montana: "bengala",
    monta√±a: "bengala",
    bosque: "fosforos",
    bunker: "linterna",
    b√∫nker: "linterna"
  };

  const keyID = refugeKeyMap[refName] || "desconocido";
  const keyLabel =
    allSupplies.find((s) => s.id === keyID)?.label || "suministro desconocido";

  // --- Mensaje inicial del Twister ---
  if (keyID === "desconocido") {
    log("‚ö†Ô∏è Advertencia: Refugio no reconocido. No se pudo determinar un suministro clave v√°lido.");
  }

  // Verificar si el jugador tiene el suministro clave
  if (state.bag.includes(keyID)) {
    mitigated = true;
    savedBySupply = keyLabel;

    // Efecto de mitigaci√≥n
    energyDamage = Math.floor(energyDamage / 2);
    healthDamage = Math.floor(healthDamage / 2);
    state.bag.splice(state.bag.indexOf(keyID), 1);

    log(
      `‚úÖ <span class="console-green">MITIGACI√ìN ACTIVADA:</span> Usaste ${savedBySupply}. El refugio resiste parte del impacto.`
    );
    log(
      `‚öôÔ∏è ${savedBySupply} reduce el da√±o del Twister a la mitad. ¬°Tu ingenio te salv√≥!`
    );
  } else {
    log(
      `‚ùå <span class="err">No ten√≠as el suministro clave (${keyLabel}).</span> El refugio recibe todo el impacto del Twister.`
    );
  }

  // Aplicar da√±o final
  state.energy = Math.max(0, state.energy - energyDamage);
  state.health = Math.max(0, state.health - healthDamage);

  log(
    `üí• Da√±o recibido ‚Äî Energ√≠a: -${energyDamage} | Salud: -${healthDamage}`
  );
  updateMeters();
  renderBag();

  // Resultado final
  const survived = state.energy > 0 && state.health > 0;

  if (survived) {
    log(
      `\nüèÜ <b>VICTORIA</b>: Resististe el impacto final del Twister.`
    );
    if (mitigated) {
      log(
        `üí™ Gracias a tu ${savedBySupply}, el ${state.refuge.toUpperCase()} se mantuvo firme entre los escombros.`
      );
    } else {
      log(
        `‚ö†Ô∏è A pesar de no tener el suministro clave (${keyLabel}), tu resistencia f√≠sica y la estructura del refugio te permitieron sobrevivir.`
      );
    }
    log(
      `üíö Estado final ‚Äî Salud: ${state.health}% | Energ√≠a: ${state.energy}%`
    );
    log(
      `üå§Ô∏è Cuando la tormenta amaina, ves el sol entre los restos del mundo. Camarada, has sobrevivido a <b>La Furia del Twister</b>.`
    );
  } else {
    updateImage("image-defeat");
    log(
      `\nüíÄ <b>DERROTA</b>: Camarada! no sobreviviste al impacto del Twister.`
    );
    log(
      `üí® El ${state.refuge.toUpperCase()} colapsa. Sin ${keyLabel}, el da√±o fue letal.`
    );
    if (mitigated) {
      log(
        `‚ö†Ô∏è Aunque usaste ${savedBySupply}, tu energ√≠a o salud eran demasiado bajas para resistir.`
      );
    } else {
      log(
        `‚ùå No ten√≠as el suministro clave (${keyLabel}) y la furia del Twister fue total.`
      );
    }
    log(
      `üíî Estado final ‚Äî Salud: ${state.health}% | Energ√≠a: ${state.energy}%`
    );
    log(`üïØÔ∏è Fin del juego.`);
  }

  // Cierre del juego
  state.started = false;
  consoleInput.disabled = true;
  consoleInput.placeholder = "Juego terminado. Reinicia la partida para jugar de nuevo.";
  updatePhaseDisplay("FIN DEL JUEGO");
}


    // --- MANEJO DE INPUT DE CONSOLA ---
    function handleInput(event){
        if(event.key === 'Enter'){
            const input = consoleInput.value.trim();
            consoleInput.value = '';
            
            log(`<span class="prompt">> ${input}</span>`);

            if(!state.started){
                log('! Pulsa "Iniciar Simulaci√≥n" primero.');
                return;
            }
            
            const parts = input.toLowerCase().split(' ');
            const command = parts[0];
            const arg = parts.slice(1).join(' ');

            // FASE 1: REFUGE 
            if(state.currentPhase === 'REFUGE'){
                chooseRefuge(input);
                return;
            }
            
            // FASE 2: SUPPLIES (y comando AVANZAR)
            if(state.currentPhase === 'SUPPLIES'){
                if(command === 'avanzar'){
                    if(state.bag.length >= 5){
                        state.currentPhase = 'ATTACKS';
                        const enemyInfo = enemyData[state.refuge];
                        log('\n<span class="prompt">‚úî AVANZANDO A ATAQUES.</span>');
                        log(`\n**AMENAZA: ${enemyInfo.name.toUpperCase()}** - Ronda ${state.rounds+1}/3`);
                        log(`> Descripci√≥n: ${enemyInfo.desc}`);
                        log(`> **DEBILIDAD** (Pista): El ${enemyInfo.name} es vulnerable a un elemento ${state.refuge === 'monta√±a' ? 'lum√≠nico' : state.refuge === 'bosque' ? 'de calor' : 'de alto voltaje'}.`);
                        log('\n¬øQu√© quieres hacer? Escribe tu primera acci√≥n: <span class="console-green">Atacar</span>, <span class="console-green">Defender</span> (usa debilidad), o <span class="console-green">Usar [suministro curativo]</span> (no consume ronda).');
                        consoleInput.placeholder = "> Escribe Atacar, Defender, o Usar [suministro]...";
                        updatePhaseDisplay('3. ATAQUES');
                    } else {
                        log(`! Todav√≠a no tienes los 5 suministros obligatorios. Tienes: ${state.bag.length}/9.`);
                    }
                } else if(command === 'a√±adir' || command === 'quitar' || command === 'combinar'){
                    handleSupplyCommand(command, arg);
                } else {
                    log('! Comando no reconocido. Usa: a√±adir, quitar, combinar, o AVANZAR.');
                }
                return;
            }

            // FASES DE ATAQUE/PUZZLE/FINAL
            if(state.currentPhase === 'ATTACKS'){
                if(command === 'atacar' || command === 'defender'){
                    attackRound(command);
                    return;
                } else if(command === 'usar' && arg) {
                    handleSupplyCommand(command, arg); // Usar curativo o no curativo
                    return;
                } else {
                     log('! Comando de ataque inv√°lido. Elige: <span class="console-green">Atacar</span>, <span class="console-green">Defender</span>, o <span class="console-green">Usar [suministro]</span>');
                     return;
                }
            }
            
            if(state.currentPhase === 'PUZZLE' && command === 'adivinar'){
                handlePuzzleInput(arg);
                return;
            }
            if(state.currentPhase === 'FINAL' && command === 'finalizar'){
                finalBattle();
                return;
            }
            
            if(command === 'ayuda'){
                showHelp();
                return;
            }
            
            log('! Comando no reconocido o fuera de fase. Escribe "ayuda" si est√°s perdido.');
        }
    }
    
    function showHelp(){
        log('\n--- AYUDA R√ÅPIDA ---');
        log('FASE 1: Escribe el nombre del refugio (ej: <b>Bosque</b>).');
        log('FASE 2: Escribe <b>a√±adir [suministro]</b>, <b>quitar [suministro]</b> o <b>combinar hierbas</b>. Luego escribe <b>AVANZAR</b>.');
        log('FASE 3: Escribe <b>Atacar</b>, <b>Defender</b>, o <b>Usar [suministro]</b> (curativo o no curativo).');
        log('FASE 4: Escribe <b>adivinar [1-5]</b>.');
        log('FASE 5: Escribe <b>finalizar</b>.');
        log('-------------------');
    }
    
    function resetDemo(){
      Object.assign(state,{started:false,refuge:null,energy:100,health:100,bag:[],rounds:0,keySupplies:[],puzzleSecret:Math.ceil(Math.random()*5), currentPhase: 'START', isPuzzleSolved: false});
      
      document.getElementById('roundTag').textContent = 'Ronda 0/3';
      document.getElementById('refugeDisplay').textContent = 'Pendiente';
      
      logEl.innerHTML = "$ SISTEMA LISTO. Pulsa \"Iniciar Simulaci√≥n\".";
      
      updateMeters(); renderBag(); 
      updateImage('map-initial');
      updateRefugeButtons(false); 
      
      consoleInput.disabled = true;
      consoleInput.placeholder = "Pulsa 'Iniciar Simulaci√≥n' para empezar.";
      updatePhaseDisplay('INICIO');
    }

    // init
    resetDemo(); 
  </script>
</body>
</html>