<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>Ceibal IDE – Loader Diagnóstico</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <style>
    body{margin:0;font-family:system-ui,Segoe UI,Roboto,Arial;background:#0b0b12;color:#e8e8f0}
    .wrap{max-width:1200px;margin:0 auto;padding:18px}
    .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
    .pill{font-family:ui-monospace,Menlo,Consolas,monospace;font-size:12px;color:#bbb;border:1px solid #2b2b44;padding:4px 8px;border-radius:999px;background:rgba(255,255,255,.03)}
    .card{background:#151526;border:1px solid #2a2a44;border-radius:14px;padding:14px;margin:12px 0}
    .k{color:#9aa1c7}
    .v{font-family:ui-monospace,Menlo,Consolas,monospace;white-space:pre-wrap;word-break:break-word}
    .ok{color:#4dd4ac}
    .err{color:#ff6b6b}
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:12px}
    .item{background:#1b1b2f;border:1px solid #2b2b4e;border-radius:12px;padding:14px;cursor:pointer}
    .item:hover{border-color:#3e8fff}
    .muted{color:#8a90b8;font-size:12px;margin-top:6px;word-break:break-word}
    button{border:1px solid #2b2b4e;background:#1b1b2f;color:#e8e8f0;border-radius:10px;padding:8px 10px;cursor:pointer;font-weight:600}
    button:hover{border-color:#3e8fff}
  </style>
</head>

<body>
<div class="wrap">
  <h1 style="margin:6px 0 10px;">Ceibal IDE – Diagnóstico de carga</h1>

  <div class="row" style="margin-bottom:10px;">
    <span class="k">URL:</span> <span class="pill" id="loc">—</span>
    <span class="k">BaseDir:</span> <span class="pill" id="base">—</span>
    <button id="btnReload">Reintentar</button>
  </div>

  <div class="card">
    <div><span class="k">Intentos de mapa:</span></div>
    <div id="tries" class="v"></div>
  </div>

  <div class="card">
    <div><span class="k">Resultado:</span> <span id="state" class="v">—</span></div>
    <div id="errbox" class="v err" style="margin-top:8px;display:none;"></div>
  </div>

  <div class="card">
    <div class="row">
      <div><span class="k">Files en mapa:</span> <span id="filesCount" class="pill">—</span></div>
      <div><span class="k">Ejercicios detectados:</span> <span id="foldersCount" class="pill">—</span></div>
    </div>
    <div id="grid" class="grid" style="margin-top:12px;"></div>
  </div>
</div>

<script>
(() => {
  const elLoc = document.getElementById("loc");
  const elBase = document.getElementById("base");
  const elTries = document.getElementById("tries");
  const elState = document.getElementById("state");
  const elErr = document.getElementById("errbox");
  const elFilesCount = document.getElementById("filesCount");
  const elFoldersCount = document.getElementById("foldersCount");
  const elGrid = document.getElementById("grid");
  document.getElementById("btnReload").addEventListener("click", () => boot());

  function computeBaseDirUrl(){
    // Siempre el directorio actual publicado (con / final)
    let p = location.pathname;
    if (!p.endsWith("/")) p = p.replace(/[^\/]*$/, "");
    return location.origin + p;
  }

  const BASE = new URL(computeBaseDirUrl());
  elLoc.textContent = location.href;
  elBase.textContent = BASE.href;

  function normPath(p){
    return String(p||"").trim().replace(/\\/g,"/").replace(/^\.\//,"").replace(/^\/+/,"");
  }

  function folderFromPath(full){
    const p = normPath(full);
    const parts = p.split("/");
    if(parts[0].toLowerCase() !== "ejercicios") return "";
    if(parts.length < 3) return "";
    return parts.slice(1, -1).join("/");
  }

  async function tryFetchJson(url){
    const res = await fetch(url, { cache: "no-cache" });
    const status = `HTTP ${res.status} ${res.ok ? "OK" : "FAIL"}`;
    return { res, status };
  }

  async function loadMapWithFallback(){
    // Rutas candidatas (mismo dir, y caso docs/)
    const candidates = [
      new URL("./mapa_del_proyecto.json", BASE).href,
      new URL("mapa_del_proyecto.json", BASE).href,
      new URL("../mapa_del_proyecto.json", BASE).href,
    ];

    elTries.textContent = candidates.map(u => "• " + u).join("\n");

    let lastErr = null;

    for (const u of candidates){
      try{
        const { res, status } = await tryFetchJson(u);
        if(!res.ok){
          lastErr = new Error(`${status} -> ${u}`);
          continue;
        }
        const data = await res.json();
        return { data, url: u };
      }catch(e){
        lastErr = e;
      }
    }

    throw lastErr || new Error("No se pudo cargar el mapa desde ninguna ruta.");
  }

  function renderFolders(folders){
    elGrid.innerHTML = "";
    for(const f of folders){
      const div = document.createElement("div");
      div.className = "item";
      div.innerHTML = `<b>${f.split("/").pop().toUpperCase()}</b><div class="muted">${f}</div>`;
      // solo para confirmar que el click funciona
      div.addEventListener("click", () => {
        location.hash = "#/ejercicio/" + encodeURIComponent(f);
        alert("Click OK: " + f + "\\n(Siguiente paso: abrir workspace/editor)");
      });
      elGrid.appendChild(div);
    }
  }

  async function boot(){
    elErr.style.display = "none";
    elErr.textContent = "";
    elState.textContent = "Cargando mapa...";
    elFilesCount.textContent = "—";
    elFoldersCount.textContent = "—";
    elGrid.innerHTML = "";

    try{
      const { data, url } = await loadMapWithFallback();

      const rawFiles = Array.isArray(data.files) ? data.files : [];
      const paths = rawFiles
        .map(x => typeof x === "string" ? normPath(x) : normPath(x.path))
        .filter(p => p.toLowerCase().startsWith("ejercicios/"));

      const folders = [...new Set(paths.map(folderFromPath).filter(Boolean))].sort((a,b)=>a.localeCompare(b));

      elState.innerHTML = `Mapa OK desde: <span class="ok">${url}</span>`;
      elFilesCount.textContent = String(paths.length);
      elFoldersCount.textContent = String(folders.length);

      if(folders.length === 0){
        elErr.style.display = "block";
        elErr.textContent =
          "El mapa cargó pero detecté 0 carpetas.\n" +
          "Ejemplo de path que leí: " + (paths[0] || "(no hay paths)") + "\n" +
          "Revisá que los paths empiecen con 'ejercicios/...'.";
      } else {
        renderFolders(folders.slice(0, 120));
      }
    }catch(e){
      elState.innerHTML = `<span class="err">Fallo cargando mapa</span>`;
      elErr.style.display = "block";
      elErr.textContent = String(e?.message || e);
      console.error(e);
    }
  }

  boot();
})();
</script>
</body>
</html>
